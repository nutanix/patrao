package upgradeagent_test

import (
	"encoding/json"
	"testing"

	"github.com/docker/docker/api/types"
	core "github.com/nutanix/patrao/internal/app/upgradeagent"
	"github.com/stretchr/testify/assert"
)

const contaienrInfo = "{\"Id\":\"18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4\",\"Created\":\"2019-07-05T12:18:33.173154817Z\",\"Path\":\"docker-entrypoint.sh\",\"Args\":[\"postgres\"],\"State\":{\"Status\":\"running\",\"Running\":true,\"Paused\":false,\"Restarting\":false,\"OOMKilled\":false,\"Dead\":false,\"Pid\":68909,\"ExitCode\":0,\"Error\":\"\",\"StartedAt\":\"2019-07-05T12:18:34.478214014Z\",\"FinishedAt\":\"0001-01-01T00:00:00Z\",\"Health\":{\"Status\":\"healthy\",\"FailingStreak\":0,\"Log\":[{\"Start\":\"2019-07-05T13:49:57.530790621Z\",\"End\":\"2019-07-05T13:49:57.640716848Z\",\"ExitCode\":0,\"Output\":\"/var/run/postgresql:5432 - accepting connections\\n\"},{\"Start\":\"2019-07-05T13:50:07.649804955Z\",\"End\":\"2019-07-05T13:50:07.754015449Z\",\"ExitCode\":0,\"Output\":\"/var/run/postgresql:5432 - accepting connections\\n\"},{\"Start\":\"2019-07-05T13:50:17.76142245Z\",\"End\":\"2019-07-05T13:50:17.863759048Z\",\"ExitCode\":0,\"Output\":\"/var/run/postgresql:5432 - accepting connections\\n\"},{\"Start\":\"2019-07-05T13:50:27.874352199Z\",\"End\":\"2019-07-05T13:50:27.980673366Z\",\"ExitCode\":0,\"Output\":\"/var/run/postgresql:5432 - accepting connections\\n\"},{\"Start\":\"2019-07-05T13:50:37.989849777Z\",\"End\":\"2019-07-05T13:50:38.108515444Z\",\"ExitCode\":0,\"Output\":\"/var/run/postgresql:5432 - accepting connections\\n\"}]}},\"Image\":\"sha256:ce795f8066a6ab07733b746df7ca0f61ab07eebb38a2c08b26fa29ba7f7b03af\",\"ResolvConfPath\":\"/var/lib/docker/containers/18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4/resolv.conf\",\"HostnamePath\":\"/var/lib/docker/containers/18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4/hostname\",\"HostsPath\":\"/var/lib/docker/containers/18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4/hosts\",\"LogPath\":\"/var/lib/docker/containers/18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4/18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4-json.log\",\"Name\":\"/test_cache_1\",\"RestartCount\":0,\"Driver\":\"overlay2\",\"MountLabel\":\"\",\"ProcessLabel\":\"\",\"AppArmorProfile\":\"\",\"ExecIDs\":null,\"HostConfig\":{\"Binds\":[],\"ContainerIDFile\":\"\",\"LogConfig\":{\"Type\":\"json-file\",\"Config\":{}},\"NetworkMode\":\"test_default\",\"PortBindings\":{},\"RestartPolicy\":{\"Name\":\"\",\"MaximumRetryCount\":0},\"AutoRemove\":false,\"VolumeDriver\":\"\",\"VolumesFrom\":[],\"CapAdd\":null,\"CapDrop\":null,\"Dns\":null,\"DnsOptions\":null,\"DnsSearch\":null,\"ExtraHosts\":null,\"GroupAdd\":null,\"IpcMode\":\"shareable\",\"Cgroup\":\"\",\"Links\":null,\"OomScoreAdj\":0,\"PidMode\":\"\",\"Privileged\":false,\"PublishAllPorts\":false,\"ReadonlyRootfs\":false,\"SecurityOpt\":null,\"UTSMode\":\"\",\"UsernsMode\":\"\",\"ShmSize\":67108864,\"Runtime\":\"runc\",\"ConsoleSize\":[0,0],\"Isolation\":\"\",\"CpuShares\":0,\"Memory\":0,\"NanoCpus\":0,\"CgroupParent\":\"\",\"BlkioWeight\":0,\"BlkioWeightDevice\":null,\"BlkioDeviceReadBps\":null,\"BlkioDeviceWriteBps\":null,\"BlkioDeviceReadIOps\":null,\"BlkioDeviceWriteIOps\":null,\"CpuPeriod\":0,\"CpuQuota\":0,\"CpuRealtimePeriod\":0,\"CpuRealtimeRuntime\":0,\"CpusetCpus\":\"\",\"CpusetMems\":\"\",\"Devices\":null,\"DiskQuota\":0,\"KernelMemory\":0,\"MemoryReservation\":0,\"MemorySwap\":0,\"MemorySwappiness\":null,\"OomKillDisable\":false,\"PidsLimit\":0,\"Ulimits\":null,\"CpuCount\":0,\"CpuPercent\":0,\"IOMaximumIOps\":0,\"IOMaximumBandwidth\":0},\"GraphDriver\":{\"Name\":\"overlay2\",\"Data\":{\"LowerDir\":\"/var/lib/docker/overlay2/5feababd5532b61b5d0f231819e9de365f21d487b7f8f19fc91d0176bc5239b1-init/diff:/var/lib/docker/overlay2/3a11d8a291a21ce5bd0996f710424e31c800219af2a4724cd20119e0d9a363e2/diff:/var/lib/docker/overlay2/98b2385342f563d938d6dea1a69e15bff2da8f6e9e58059725aac9ebc77d5289/diff:/var/lib/docker/overlay2/00df524e616c8a6bdb60c7400f8d95219e7c0eaa3d82818d7cbdb102b7f44ba9/diff:/var/lib/docker/overlay2/6494fa887c7bcd7a00bc66b7eb6df6f5ecd750014a47396a788866df8ff75ae7/diff:/var/lib/docker/overlay2/10601fdd23d3a6d909921bb82ffab259562872225a801babb470f7004b539386/diff:/var/lib/docker/overlay2/f9fe726ea8612294f4cf169e838ce4af13985336f65f3afdf8a7074beac89b95/diff:/var/lib/docker/overlay2/138ea63991a05770c0d8073854cd162ba2dffb1c10372c5393319575e41beb50/diff:/var/lib/docker/overlay2/dc1796eb5ab7b90c1715002cf885731cab756773076f5928c40395fbbc172e85/diff:/var/lib/docker/overlay2/b79ddbda086084e0e7c27ef299c35bc91c717948e1ac4d6034a35fea02c64193/diff:/var/lib/docker/overlay2/01e4f2affb14cd92e6c21056c906d528aaceee78c6328e90a43834da0651a2bc/diff:/var/lib/docker/overlay2/2e2c032f267d5a1115bac8659ef4bde8a43c04d0e476e4e2b5807ca01f2cb674/diff:/var/lib/docker/overlay2/39ad423b56353da2f126218fe9692fcb9e101a55fa8d7824084e81316a17863e/diff:/var/lib/docker/overlay2/3b2f00157bc2b46e05f71d7334d01715f21af75fa8fd8520ee7951822ec537a6/diff:/var/lib/docker/overlay2/bc6b990b035d89172044c4dfec6d33205f01730a794831bbbce44af7e0bbab2a/diff\",\"MergedDir\":\"/var/lib/docker/overlay2/5feababd5532b61b5d0f231819e9de365f21d487b7f8f19fc91d0176bc5239b1/merged\",\"UpperDir\":\"/var/lib/docker/overlay2/5feababd5532b61b5d0f231819e9de365f21d487b7f8f19fc91d0176bc5239b1/diff\",\"WorkDir\":\"/var/lib/docker/overlay2/5feababd5532b61b5d0f231819e9de365f21d487b7f8f19fc91d0176bc5239b1/work\"}},\"Mounts\":[{\"Type\":\"volume\",\"Name\":\"05bb630b6a0f339faa0706ac8ae8afa804050b64d7894c0d6aae5894cb7c1bd8\",\"Source\":\"/var/lib/docker/volumes/05bb630b6a0f339faa0706ac8ae8afa804050b64d7894c0d6aae5894cb7c1bd8/_data\",\"Destination\":\"/var/lib/postgresql/data\",\"Driver\":\"local\",\"Mode\":\"\",\"RW\":true,\"Propagation\":\"\"}],\"Config\":{\"Hostname\":\"18031f7e098a\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"ExposedPorts\":{\"5432/tcp\":{}},\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/9.5/bin\",\"GOSU_VERSION=1.11\",\"LANG=en_US.utf8\",\"PG_MAJOR=9.5\",\"PG_VERSION=9.5.17-1.pgdg90+1\",\"PGDATA=/var/lib/postgresql/data\"],\"Cmd\":[\"postgres\"],\"Healthcheck\":{\"Test\":[\"CMD-SHELL\",\"pg_isready -U postgres\"],\"Interval\":10000000000,\"Timeout\":5000000000,\"Retries\":5},\"ArgsEscaped\":true,\"Image\":\"postgres:9.5\",\"Volumes\":{\"/var/lib/postgresql/data\":{}},\"WorkingDir\":\"\",\"Entrypoint\":[\"docker-entrypoint.sh\"],\"OnBuild\":null,\"Labels\":{\"com.docker.compose.config-hash\":\"4bb26e2a02302e14145e88e7375f70f16c9f8a0a97e3999ceebe6949367c2b5e\",\"com.docker.compose.container-number\":\"1\",\"com.docker.compose.oneoff\":\"False\",\"com.docker.compose.project\":\"test\",\"com.docker.compose.service\":\"cache\",\"com.docker.compose.version\":\"1.23.2\"}},\"NetworkSettings\":{\"Bridge\":\"\",\"SandboxID\":\"bcc590c0135ab7e9fbbd1e8e97b4c65799b942466c5fbd909dc54c8ce2c48b2e\",\"HairpinMode\":false,\"LinkLocalIPv6Address\":\"\",\"LinkLocalIPv6PrefixLen\":0,\"Ports\":{\"5432/tcp\":null},\"SandboxKey\":\"/var/run/docker/netns/bcc590c0135a\",\"SecondaryIPAddresses\":null,\"SecondaryIPv6Addresses\":null,\"EndpointID\":\"\",\"Gateway\":\"\",\"GlobalIPv6Address\":\"\",\"GlobalIPv6PrefixLen\":0,\"IPAddress\":\"\",\"IPPrefixLen\":0,\"IPv6Gateway\":\"\",\"MacAddress\":\"\",\"Networks\":{\"test_default\":{\"IPAMConfig\":null,\"Links\":null,\"Aliases\":[\"18031f7e098a\",\"cache\"],\"NetworkID\":\"76e92408ac1f0e8675cc7b77ef1e903d52f6f41c27c52fceaf46c628268726f8\",\"EndpointID\":\"b75fd289909d3c2b36309d03354b0e09519d9cb3e1294fd9026db962467c539d\",\"Gateway\":\"172.20.0.1\",\"IPAddress\":\"172.20.0.3\",\"IPPrefixLen\":16,\"IPv6Gateway\":\"\",\"GlobalIPv6Address\":\"\",\"GlobalIPv6PrefixLen\":0,\"MacAddress\":\"02:42:ac:14:00:03\"}}}}"
const imageInfo = "{\"Id\":\"sha256:ce795f8066a6ab07733b746df7ca0f61ab07eebb38a2c08b26fa29ba7f7b03af\",\"RepoTags\":[\"postgres:9.5\"],\"RepoDigests\":[\"postgres@sha256:871f1d9e6d9eccbebfc0744bdb1733170acd9135b5cf0e0f5b68d07ddd02884f\"],\"Parent\":\"\",\"Comment\":\"\",\"Created\":\"2019-05-10T01:38:19.161906478Z\",\"Container\":\"f639f6db595b28e4319d5bf2417cec317633cbce461a2a3e81e25d5faa4b7822\",\"ContainerConfig\":{\"Hostname\":\"f639f6db595b\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"ExposedPorts\":{\"5432/tcp\":{}},\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/9.5/bin\",\"GOSU_VERSION=1.11\",\"LANG=en_US.utf8\",\"PG_MAJOR=9.5\",\"PG_VERSION=9.5.17-1.pgdg90+1\",\"PGDATA=/var/lib/postgresql/data\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"postgres\\\"]\"],\"ArgsEscaped\":true,\"Image\":\"sha256:fc48514d31e166bd6ddb25d1e86fa518622d05d930d2a9e6b62be9f8bd9715e3\",\"Volumes\":{\"/var/lib/postgresql/data\":{}},\"WorkingDir\":\"\",\"Entrypoint\":[\"docker-entrypoint.sh\"],\"OnBuild\":null,\"Labels\":{}},\"DockerVersion\":\"18.06.1-ce\",\"Author\":\"\",\"Config\":{\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"ExposedPorts\":{\"5432/tcp\":{}},\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/9.5/bin\",\"GOSU_VERSION=1.11\",\"LANG=en_US.utf8\",\"PG_MAJOR=9.5\",\"PG_VERSION=9.5.17-1.pgdg90+1\",\"PGDATA=/var/lib/postgresql/data\"],\"Cmd\":[\"postgres\"],\"ArgsEscaped\":true,\"Image\":\"sha256:fc48514d31e166bd6ddb25d1e86fa518622d05d930d2a9e6b62be9f8bd9715e3\",\"Volumes\":{\"/var/lib/postgresql/data\":{}},\"WorkingDir\":\"\",\"Entrypoint\":[\"docker-entrypoint.sh\"],\"OnBuild\":null,\"Labels\":null},\"Architecture\":\"amd64\",\"Os\":\"linux\",\"Size\":226669186,\"VirtualSize\":226669186,\"GraphDriver\":{\"Name\":\"overlay2\",\"Data\":{\"LowerDir\":\"/var/lib/docker/overlay2/98b2385342f563d938d6dea1a69e15bff2da8f6e9e58059725aac9ebc77d5289/diff:/var/lib/docker/overlay2/00df524e616c8a6bdb60c7400f8d95219e7c0eaa3d82818d7cbdb102b7f44ba9/diff:/var/lib/docker/overlay2/6494fa887c7bcd7a00bc66b7eb6df6f5ecd750014a47396a788866df8ff75ae7/diff:/var/lib/docker/overlay2/10601fdd23d3a6d909921bb82ffab259562872225a801babb470f7004b539386/diff:/var/lib/docker/overlay2/f9fe726ea8612294f4cf169e838ce4af13985336f65f3afdf8a7074beac89b95/diff:/var/lib/docker/overlay2/138ea63991a05770c0d8073854cd162ba2dffb1c10372c5393319575e41beb50/diff:/var/lib/docker/overlay2/dc1796eb5ab7b90c1715002cf885731cab756773076f5928c40395fbbc172e85/diff:/var/lib/docker/overlay2/b79ddbda086084e0e7c27ef299c35bc91c717948e1ac4d6034a35fea02c64193/diff:/var/lib/docker/overlay2/01e4f2affb14cd92e6c21056c906d528aaceee78c6328e90a43834da0651a2bc/diff:/var/lib/docker/overlay2/2e2c032f267d5a1115bac8659ef4bde8a43c04d0e476e4e2b5807ca01f2cb674/diff:/var/lib/docker/overlay2/39ad423b56353da2f126218fe9692fcb9e101a55fa8d7824084e81316a17863e/diff:/var/lib/docker/overlay2/3b2f00157bc2b46e05f71d7334d01715f21af75fa8fd8520ee7951822ec537a6/diff:/var/lib/docker/overlay2/bc6b990b035d89172044c4dfec6d33205f01730a794831bbbce44af7e0bbab2a/diff\",\"MergedDir\":\"/var/lib/docker/overlay2/3a11d8a291a21ce5bd0996f710424e31c800219af2a4724cd20119e0d9a363e2/merged\",\"UpperDir\":\"/var/lib/docker/overlay2/3a11d8a291a21ce5bd0996f710424e31c800219af2a4724cd20119e0d9a363e2/diff\",\"WorkDir\":\"/var/lib/docker/overlay2/3a11d8a291a21ce5bd0996f710424e31c800219af2a4724cd20119e0d9a363e2/work\"}},\"RootFS\":{\"Type\":\"layers\",\"Layers\":[\"sha256:6270adb5794c6987109e54af00ab456977c5d5cc6f1bc52c1ce58d32ec0f15f4\",\"sha256:1e18901583690e87e5fb18b7b8f800e1c6086f24d9e42665f5ff271ed9ad6fe1\",\"sha256:8700c6d5f108c594900503ed0cdfe81717172fb334989669badd9a7bc6686151\",\"sha256:b4505242243cbea7f12f77bdfe54a1b33463c858e1a1474ca8d6c5c345039b1d\",\"sha256:8ffc50431e46019230f6aedd658f4cbb2c0186dd1b34c141f7623be63ea41709\",\"sha256:2684171886966b1f764c1bc290a4cabdd026a955c0ad2104eccbb39ab8d60999\",\"sha256:da1749281c4c09242a631b2445fc3eea5ad82da4bb6baf1f9ed4f83534b954df\",\"sha256:804abd5012d6d250ba4cb03479a1610e9454c4ef570f2e6408201b27c6895a9a\",\"sha256:3ceff38b896a5506f581b979296767093b9330921d8af9efe76ebe90ce1ca059\",\"sha256:264ebd8b05e57c398294d7e094409457285482ae9fb9ef17ced3d83bf3bff60f\",\"sha256:9935f54b745056c93bf642fe59cbc644b67eaee65f0add76e6c49cb846d474f8\",\"sha256:9311096db884236a893089a54228def30e8c62a8c16ea35c15b547f97218f396\",\"sha256:1b170f2367d75a462899d8649eccb82eca79e820bc304ffd384d953b9b726153\",\"sha256:263c9b249b46f9394e63311423f0e4cb3d3c87e5e801bc37ad841253fb1385de\"]}}"
const containerID = "18031f7e098a81df3eee505981ba395662d5142272cf0b3e2c22e70f32aa1ac4"
const containerName = "/test_cache_1"
const imageName = "postgres:9.5"

func createTestData(t *testing.T) (types.ContainerJSON, types.ImageInspect) {
	var (
		container types.ContainerJSON
		image     types.ImageInspect
	)

	err := json.Unmarshal([]byte(contaienrInfo), &container)
	assert.NoError(t, err)
	err = json.Unmarshal([]byte(imageInfo), &image)
	assert.NoError(t, err)
	return container, image
}

func createTestContainer(t *testing.T) *core.Container {
	container, image := createTestData(t)
	c := core.NewContainer(&container, &image)
	assert.NotNil(t, c)
	return c
}

func TestNewContainer(t *testing.T) {
	container, image := createTestData(t)

	assert.NotNil(t, core.NewContainer(nil, nil))
	assert.NotNil(t, core.NewContainer(&container, &image))
}

func TestID(t *testing.T) {
	c := createTestContainer(t)
	assert.Equal(t, containerID, c.ID())
}

func TestName(t *testing.T) {
	c := createTestContainer(t)
	assert.Equal(t, containerName, c.Name())
}

func TestImageName(t *testing.T) {
	c := createTestContainer(t)
	assert.Equal(t, imageName, c.ImageName())
}
